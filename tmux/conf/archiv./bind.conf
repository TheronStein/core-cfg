# === Keybinds ============================================================== [[[
# TIP:
# Prefix + '               => Select index
# Prefix + i               => Show information
# Prefix + C               => Customize options
# Prefix + ~               => Tmux log/msg output
# :show-options -s|g|w     => Show options
# :show-hooks -g           => Show hooks
# :showmsgs                => Show log
# :showphist               => Show prompt history

#https://github.com/tmux/tmux/issues/2000

unbind "C-s"
unbind "C-r"

bind -N "List keys" M-F12 list-keys
bind -N "Customize Menu" f1 customize-mode
# bind f9 run-shell "${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/install_plugins.sh"
# bind f10 run-shell "${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/update_plugin.sh"
# bind f11 run-shell "${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/source_plugins.sh"
# bind f12 run-shell "${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/clean_plugins.sh"

# # Create a script aor the window menu
# bind-key -N "Plugin Management" C-F9 \
# display-menu -x W -y S \
#     "Install Plugins"   i "run-shell '${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/install_plugins.sh'" \
#     "Update Plugins"    u "run-shell '${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/update_plugin.sh'" \
#     "Source Plugins"    s "run-shell '${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/source_plugins.sh'" \
#     "Clean Plugins"     c "run-shell '${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/clean_plugins.sh'" \
#     "List Plugins"      l "run-shell '${TMUX_PLUGIN_MANAGER_PATH}/tpm/scripts/list_plugins.sh'" \
#     "Back"             ESC "run-shell 'tmux send-keys Escape'"
#
# # Create a script aor the window menu
# bind-key -N "Pane Management" C-F10 \
# display-menu -x W -y S \
#     "Break Pane"       b "break-pane" \
#     "Move Pane"        m "move-pane -t :+1" \
#     "Swap Pane"        s "swap-pane -t :+1" \
#     "Kill Pane"        x "kill-pane" \
#     "Back"             ESC "run-shell 'tmux send-keys Escape'"
#
# # Create a script for the window menu
# bind-key -N "Window Management" C-F11 \
#   display-menu -x W -y S \
#     "New Window"       N "new-window" \
#     "Rename Window"        r "command-prompt -I '#W' 'rename-window %%'" \
#     "Kill Window"        x "kill-window" \
#     "Back"                 ESC "run-shell 'tmux send-keys Escape'"
#
# # Create a script for the window menu
# bind-key -N "Session Management" C-F12 \
#   display-menu -x W -y S \
#     "New Session"       N "new-window" \
#     "Rename Session"        r "command-prompt -I '#W' 'rename-window %%'" \
#     "Kill Sesssion"        x "kill-session" \
#     # "Manage Sessions"       m "send-keys 'prefix' ''" \
#     "Back"                 ESC "run-shell 'tmux send-keys Escape'"
#
# # Main menudisplay-menu -x W -y S e
# bind-key -N "Display help menu" ! \
# display-menu -x W -y S \
#     "Reload Config"     r "source-file ~/.tmux/tmux.conf \; display-message 'Config reloaded'" \
#     "Horizontal Split"  h "split-window -h" \
#     "Vertical Split"    v "split-window -v" \
#     "Zoom Toggle"       z "resize-pane -Z" \
#     "Pane Management"   p "send-keys C-Space C-F10" \
#     "Plugin Management" P "send-keys C-Space C-F9" \
#     "Window Management" w "send-keys C-Space C-F11" \
#     "Session Management" s "send-keys C-Space C-F12"

# Main Menu
# bind-key -N "Display help menu" ! \
#     display-menu -x W -y S \
#     "Reload Config"     r "source-file ~/.tmux/tmux.conf \; display-message 'Config reloaded'" \
#     "Horizontal Split"  h "split-window -h" \
#     "Vertical Split"    v "split-window -v" \
#     "Zoom Toggle"       z "resize-pane -Z" \
#     "Pane Management"   p "run-shell 'tmux display-menu -x W -y S \"Break Pane\" b \"break-pane\" \"Move Pane\" m \"move-pane -t :+1\" \"Swap Pane\" s \"swap-pane -t :+1\" \"Kill Pane\" x \"kill-pane\"'" \
#     "Plugin Management" P "run-shell 'tmux display-menu -x W -y S \"Install\" i \"run-shell ~/.tmux/plugins/tpm/scripts/install_plugins.sh\" \"Update\" u \"run-shell ~/.tmux/plugins/tpm/scripts/update_plugin.sh\"'" \
#     "Window Management" w "run-shell 'tmux display-menu -x W -y S \"New Window\" n \"new-window\" \"Kill Window\" x \"kill-window\" \"Rename\" r \"command-prompt -I #W rename-window %%\"'" \
#     "Session Management" s "choose-sessio

# Bind individual menus to function keys
bind-key -N "Plugin Management" -n 'M-F6' run-shell '~/.core/cfg/tmux/scripts/menus/plugin-menu.sh'
bind-key -N "Pane Management" -n 'M-F2' run-shell '~/.core/cfg/tmux/scripts/menus/pane-menu.sh'
bind-key -N "Window Management" -n 'M-F3' run-shell '~/.core/cfg/tmux/scripts/menus/window-menu.sh'
bind-key -N "Session Management" -n 'M-F4' run-shell '~/.core/cfg/tmux/scripts/menus/session-menu.sh'
bind-key -N "Task Management" -n 'M-F5' run-shell '~/.core/cfg/tmux/scripts/menus/save-restore-menu.sh'

# Main menu
bind-key -N "Display help menu" -n C-1 run-shell '/home/theron/.core/cfg/tmux/scripts/menus/main-menu.sh'

bind g display-popup -E -w 75% -h 75% "\
  tmux list-sessions -F '#{?session_attached,,#{session_name}}' |\
  sed '/^$/d' |\
  fzf --reverse --header jump-to-session --preview 'tmux capture-pane -pt {}'  |\
  xargs tmux switch-client -t"


# # Must have -N 'notes'
bind -N "Show keybindings" C-! { list-keys -N }
bind -N 'Describe keybinding' C-~ { command-prompt -kpkey { list-keys -1N '%%' } }

# Share specific windows between sessions
bind-key C-S-s command-prompt -p "Share window to session:" \
  "link-window -s . -t '%%'"

# bind-key -N "Interactive chooser" ^ choose-tree -F "#{s/^//:#{b:pane_current_path}}"
# Save with timestamp feedback
# bind-key C-s run-shell "bash -c '~/.core/cfg/tmux/plugins/tmux-resurrect/scripts/save.sh && tmux display-message \"Session saved at \$(date +%H:%M:%S)\"'"

bind-key M command-prompt -p "Set task for session:" \
  "set -t '%%' @task '%%'"

bind c new-window -c '#{pane_current_path}' -a -t '{next}'

bind -n M-z resize-pane -Z
#
# bind = split-window -h -c '#{pane_current_path}' \; select-pane -t '.+'
# bind - split-window -v -c '#{pane_current_path}' \; select-pane -t '.+'

#New window/session
# bind -N 'Create new session' -n C-M-c new
# bind -N 'Create new window (send to right)' c neww -ac "#{pane_current_path}"
# bind -N 'Create new window (send to end)' C neww -c "#{pane_current_path}"
# Swap pane
# bind -N "Swap prev pane" -r C-S-n swapp -U
# bind -N "Swap next pane" -r C-n swapp -D
# === Q/E binds  ================================================ [[[

#
# # Switch windows
bind -N 'Select prev window' q \
     if -F '#{>:#{session_windows},1}' { previous-window } { neww -c "#{pane_current_path}" }
bind -N 'Select next window' e \
     if -F '#{>:#{session_windows},1}' { next-window }     { neww -c "#{pane_current_path}" }
#
bind -N "Swap prev window and follow" -r Q {
  swapw  -d -t -1
  display "#{window_index} <= #{e|+:#{window_index},1}"
}
bind -N "Swap next window and follow" -r E {
  swapw  -d -t +1
  display "#{e|-:#{window_index},1} => #{window_index}"
}

# # Swap windows
bind -N "Swap prev window" 'M-S-n' swapw -t -1
bind -N "Swap next window" 'M-n' swapw -t +1
#
# # Switch sessions
bind -N "Switch prev session" -r 'C-M-q' { switchc -p }
bind -N "Switch next session" -r 'C-M-e' { switchc -n }
bind -N "Switch to the last session" 'C-S-b' { switchc -l }
#
# # Cycle windows/panes (no prefix)
bind -n C-S-x selectp -t :.+ \; resizep -Z # next pane zoom
bind -n C-x selectp -t :.+               # next pane
bind -n C-e selectw -t :+                # next window
bind -n C-q selectw -t :-                # previous window
bind -N 'Clock mode' F4 clock-mode
bind -N "Toggle statusbar" C-S-t if -F '#{==:#{status},on}' 'set status off' 'set status on'

# Switch between synchronize all pane
bind -N "Toggle pane synchronization" C-y \
  if -F '#{pane_synchronized}' {
    set -w synchronize-panes off; display "Sync off"
  } {
    set -w synchronize-panes on; display  "Sync on"
  }

# Renaming
bind -N "Rename session" R command-prompt -I "#S" "rename-session '%%'"
bind -N "Rename window" r command-prompt "renamew %%"

# Edit config
bind -N "Edit configuration" \
  T neww -n 'conf' \
    'nvim $CORECFG/tmux/tmux.conf && \
     tmux source $CORECFG/tmux/tmux.conf && \
     tmux display "===== Configuration reloaded ====="'

# Select last
bind -N 'Select last pane' M-l lastp
bind -N 'Select last window' C-l last
# bind -n -N 'Select last window' C-S-f last

# Select pane movement
# bind -n M-S-Left selectp -L
# bind -n M-S-Down selectp -D
# bind -n M-S-Up selectp -U
# bind -n M-S-Right selectp -R

# Pane move
bind M-m move-pane -t '.-'
bind M-h move-pane -h -t '.-'
unbind -n [
unbind -n ]

bind -r C-d select-pane -t :.+
bind -r D select-window -t :-
bind -r d select-window -t :+

# == Resize / Split ========================================================= [[[
bind -N "Resize pane leftward"  -r A resizep -L 2
bind -N "Resize pane rightward" -r D resizep -R 2
bind -N "Resize pane downward"  -r S resizep -D 2
bind -N "Resize pane upward"    -r W resizep -U 2

# bind M-.  switchc -T resize
bind -N "Maximize pane" Z resizep -Z
bind -N "Rotate window" -r M-r rotate-window
bind -N "Rotate window layout" M-t next-layout

# Select layout
bind -N "Spread panes out evenly" M-y { select-layout -E }
bind -N "Select even-horizontal layout " -Tresize M-1 selectl even-horizontal \; switchc -Tresize
bind -N "Select even-vertical layout "   -Tresize M-2 selectl even-vertical   \; switchc -Tresize
bind -N "Select main-horizontal layout " -Tresize M-3 selectl main-horizontal \; switchc -Tresize
bind -N "Select main-vertical layout "   -Tresize M-4 selectl main-vertical   \; switchc -Tresize
bind -N "Select tiled layout"            -Tresize M-5 selectl tiled           \; switchc -Tresize

bind -N "Select window 1"  -T resize 1 selectp -t :.1 \; switchc -T resize
bind -N "Select window 2"  -T resize 2 selectp -t :.2 \; switchc -T resize
bind -N "Select window 3"  -T resize 3 selectp -t :.3 \; switchc -T resize
bind -N "Select window 4"  -T resize 4 selectp -t :.4 \; switchc -T resize
bind -N "Select window 5"  -T resize 5 selectp -t :.5 \; switchc -T resize
bind -N "Select window 6"  -T resize 6 selectp -t :.6 \; switchc -T resize
bind -N "Select window 7"  -T resize 7 selectp -t :.7 \; switchc -T resize
bind -N "Select window 8"  -T resize 8 selectp -t :.8 \; switchc -T resize
bind -N "Select window 9"  -T resize 9 selectp -t :.9 \; switchc -T resize
bind -N "Select window 10" -T resize 0 selectp -t :.10 \; switchc -T resize

# bind -N 'Clear the marked pane' M { select-pane -M }

# bind -N "Split pane horizontally" v \
#   if -F '#{!=:#S,floating}' {
#       splitw -v -c '#{pane_current_path}'
#   } {
#       set -uw pane-border-status
#       run "$BIN_DIR/fzf-panes.tmux update_mru_pane_ids"
#       run 'bash -c "tmux joinp -v -s floating -t \"$(tmux show -gvq '@last_session_name'):\""'
#   }
#
# bind -N "Split pane vertically" V \
#   if -F '#{!=:#S,floating}' {
#       splitw -h -c '#{pane_current_path}'
#   } {
#       set -uw pane-border-status
#       run "$BIN_DIR/fzf-panes.tmux update_mru_pane_ids"
#       run 'bash -c "tmux joinp -h -s floating -t \"$(tmux show -gvq '@last_session_name'):\""'
#   }
# ]]]    bind -N "Move to selected window" m  run -b "$BIN_DIR/fzf-panes.tmux new_window"

# == Pane Switch ============================================================ [[[
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind -n -N "Select the pane to the left" C-a \
  if-shell "$is_vim" { send C-a } { if -F '#{pane_at_left}'   '' 'selectp -L' 
bind -n -N "Select the pane to the bottom" C-s \
  if-shell "$is_vim" { send C-s } { if -F '#{pane_at_bottom}' '' 'selectp -D' }
bind -n -N "Select the pane to the bottom" C-w \
  if-shell "$is_vim" { send C-w } { if -F '#{pane_at_top}'    '' 'selectp -U' }
bind -n -N "Select the pane to the right" C-d \
  if-shell "$is_vim" { send C-d } { if -F '#{pane_at_right}'  '' 'selectp -R' }

bind -T copy-mode-vi 'C-a' if -F '#{pane_at_left}' '' 'select-pane -L'
bind -T copy-mode-vi 'C-s' if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi 'C-w' if -F '#{pane_at_top}' '' 'select-pane -U'
bind -T copy-mode-vi 'C-d' if -F '#{pane_at_right}' '' 'select-pane -R'
bind -T copy-mode-vi C-l selectp -l

# == Interactive Keybinds =================================================== [[[
bind -N "Interactively choose session" w { choose-tree -Zs }
# bind -N "Interactively choose window"  { choose-tree -Z }
bind -N "Swap windows, don't follow" C-S-w choose-tree { swapw -t "%%" }
bind -N "Swap windows, follow" C-w choose-tree { swapw -dt "%%" }
bind -N "Swap panes/windows, don't follow" M-S-w choose-tree { swapp -t "%%" }
bind -N "Send current pane vertically" 'M-S-c' choose-tree { joinp -fh -t "%%" }
bind -N "Send current pane horizontally" 'M-c' choose-tree { joinp -fv -t "%%" }
bind -N "Move window after selected, follow" M-e choose-tree { movew -at "%%" }
bind -N "Move window before selected, follow" M-q choose-tree { movew -bt "%%" }
bind -N "Move window before selected, don't follow" M-S-q choose-tree { movew -dbt "%%" }
bind -N "Move window after selected, don't follow" M-S-e choose-tree { movew -dat "%%" }

# Join pane to window/session (interactively)
bind j choose-tree -Zw { movep -t '%%' }
bind J choose-tree -Zw { movew -t '%%' }
# bind @ join-pane -hs ! # most recently visitedbind
bind -n C-j choose-tree -Zw "swapw -t '%%'"
# bind w choose-tree -s

# Throw a pane into current pane from another window
bind -N "Join pane with current, vertically" M-g choose-tree { joinp -fh -s "%%" }
bind -N "Join pane with current, vertically" = choose-tree { joinp -fh -s "%%" }
bind -N "Join pane with current, horizontally" - choose-tree { joinp -fv -s "%%" }
bind -N "Join pane with current, horizontally" M-S-g choose-tree { joinp -fv -s "%%" }
# bind -N "Join pane with current, horizontally" -n C-g choose-tree { joinp -fv -s "%%" }
# bind -N "Join pane with current, vertically" -n  choose-tree { joinp -fh -s "%%" }
#
# bind C command-prompt -p "Swap Current Window To? (e.g 3; 4; session_name:5)" "swapw -t '%%'"
# bind c command-prompt -p "Swap Current Pane To? (e.g 2.0; session_name:4.0)" "swap-pane -t '%%'"
# bind M-c command-prompt -p "Move Current Pane To? (e.g 3.1; session_name:6.0)" "move-pane -t '%%'"

if "[[ -x $BIN_DIR/fzf-panes.tmux ]]" {
    set -g '@fzf_panes_ex_session_pat' '^(floating)$'
    set-hook -g pane-focus-in[10] "if -F \
        '#{&&:#{!=:#{client_key_table},resize},#{!=:#{session_name},floating}}' \
        'run -b \"$BIN_DIR/fzf-panes.tmux update_mru_pane_ids\"'"
    bind -N "Move to selected window" C-m m run -b "$BIN_DIR/fzf-panes.tmux new_window"
    bind -N "Move to last window" C-b run -b "$BIN_DIR/fzf-panes.tmux select_last_pane"
    bind -N "Move to selected window" -n M-m run -b "$BIN_DIR/fzf-panes.tmux new_window"
} {
    set-hook -ug pane-focus-in[10]
    bind -N "Move to selected window" C-m choose-tree -Z
    bind -N "Move to last window" C-b choose-tree { movep -v -s "%%" }
    bind -N "Move to selected window" C-m choose-tree { movep -h -s "%%" }
}

bind -N "Swap pane with selected pane" M-v displayp { swapp -t '%%' }
bind -N "Display pane numbers" 'M-#' displayp

bind -N "Break pane, send to end, follow" b \
  if -F '#{!=:#S,floating}' {
    breakp
  } {
    set -uw pane-border-status
    run "$BIN_DIR/fzf-panes.tmux update_mru_pane_ids"
    run 'bash -c "tmux breakp -s floating -t \"$(tmux show -gvq '@last_session_name'):\""'
  }

bind -N "Break pane, send to end, don't follow" 'B' \
  if -F '#{!=:#S,floating}' {
    breakp -d
  } {
    set -uw pane-border-status
    run "$BIN_DIR/fzf-panes.tmux update_mru_pane_ids"
    run 'bash -c "tmux breakp -d -s floating -t \"$(tmux show -gvq '@last_session_name'):\""'
  }

bind -N "Break pane, send to left, don't follow" M-b breakp -bd

bind -N "Kill pane with confirmation" x { confirm-before -p "kill-pane #P? [Y/n]" killp }
bind -N "Kill window with confirmation" X { confirm-before -p "kill-window #W? [Y/n]" killw }
bind -N "Kill session with confirmation" -n C-S-x { confirm-before -p "kill-session #S? [Y/n]" kill-session }
bind -N "Kill server with confirmation" -n C-S-q { confirm-before -p "kill tmux? [Y/n]" kill-server }
# ]]]

# === Mouse === [[[
bind -N "Toggle mouse OFF" '<' { set -gq mouse off; display 'Mouse: OFF' }
bind -N "Toggle mouse ON"  ',' { set -gq mouse on ; display 'Mouse: ON' }
# bind -N "Toggle mouse" m \
#   if -F '#{==:#{mouse},on}' {
#     set -gq mouse off
#     display 'Mouse: OFF'
#   } {
#     set -gq mouse on
#     display 'Mouse: ON'
#   }

bind -T root WheelUpPane \
  if -Ft= '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if -Ft= "#{alternate_on}" "send -t= Up" "copy-mode -et="'

bind -T root WheelDownPane \
  if -Ft = '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if -Ft= "#{alternate_on}"  "send -t= Down" "send -Mt="'

# bind -T root WheelUpPane   if -F -t = "#{alternate_on}" "send -M" "selectp -t =; copy-mode -e; send -M"
# bind -T root WheelDownPane if -F -t = "#{alternate_on}" "send -M" "selectp -t =; send -M"
# ]]]

# == Menu / Floating Windows ================================================ [[[
# bind "C-'" display-popup -h 40 -w 95 -E "tmux new-session -A -s popup"  # Start a floating session
# bind C-b splitw -h 40 -w 95 -p 40 -b -c ' # {pane_current_path}' lf # Open lf file manager

# # === htop ===
# bind -N "Open htop, new window" C-h {
#     neww -n htop -c $HOME
#     send 'sudo htop && tmux killw' 'Enter'
# }

# Floating shell
bind -n -N "Attach a floating shell" 'M-`'\
  if -F '#{==:#S,floating}' {
    detach
  } {
    set -gF '@last_session_name' '#S'
    detach -s floating
    popup -d '#{pane_current_path}' -xC -yC -w80% -h60% -E 'tmux new -A -s floating \
    "tmux set -w pane-border-status off; TMUX_SESSION=floating $SHELL"'
  }
# ]]]

# == Tmux completion ==
bind -n -N "Select pane (fzf)" M-y \
     run "tmux-fzf-panes || :"
bind -N "Select words to paste from buffer (fzf)"      t \
     run 'tmux send-keys -t #{pane_id} "$(tmux-fzf-words)"'
bind -N "Select words to paste from all buffers (fzf)" T \
     run 'tmux send-keys -t #{pane_id} "$(tmux-fzf-words --all)"'

# bind -N "Capture pane and open in Vim" C-M-e run \
#   'FILE=/tmp/tmux-capture-$(date +%Y%m%d%H%M%S).txt; \
#   tmux capture-pane -J -S -102400 -p > $FILE; \
#   tmux neww "nvim $FILE"'
