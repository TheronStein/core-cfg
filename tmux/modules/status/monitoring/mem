#!/usr/bin/env bash
# Memory usage monitoring script for tmux status bar

if [ -f /proc/meminfo ]; then
    # Linux - read from /proc/meminfo
    mem_total=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    mem_available=$(grep MemAvailable /proc/meminfo | awk '{print $2}')

    if [ -n "$mem_total" ] && [ -n "$mem_available" ]; then
        mem_used=$((mem_total - mem_available))
        mem_percent=$((100 * mem_used / mem_total))

        # Convert to GB for display
        mem_used_gb=$(awk "BEGIN {printf \"%.1f\", $mem_used/1024/1024}")
        mem_total_gb=$(awk "BEGIN {printf \"%.1f\", $mem_total/1024/1024}")

        printf "%s/%sG (%d%%)" "$mem_used_gb" "$mem_total_gb" "$mem_percent"
    else
        echo "N/A"
    fi
elif command -v vm_stat &>/dev/null; then
    # macOS - use vm_stat
    page_size=$(vm_stat | grep "page size" | awk '{print $8}')
    pages_free=$(vm_stat | grep "Pages free" | awk '{print $3}' | tr -d '.')
    pages_active=$(vm_stat | grep "Pages active" | awk '{print $3}' | tr -d '.')
    pages_inactive=$(vm_stat | grep "Pages inactive" | awk '{print $3}' | tr -d '.')
    pages_wired=$(vm_stat | grep "Pages wired down" | awk '{print $4}' | tr -d '.')

    mem_used=$(((pages_active + pages_wired) * page_size / 1024 / 1024 / 1024))
    mem_total=$(((pages_free + pages_active + pages_inactive + pages_wired) * page_size / 1024 / 1024 / 1024))
    mem_percent=$((100 * mem_used / mem_total))

    printf "%dG/%dG (%d%%)" "$mem_used" "$mem_total" "$mem_percent"
else
    # Fallback: use free command
    if command -v free &>/dev/null; then
        free -h | awk '/Mem:/ {printf "%s/%s", $3, $2}'
    else
        echo "N/A"
    fi
fi
