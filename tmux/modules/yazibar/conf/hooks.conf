# Yazibar - Hooks Configuration
# Tmux hooks for automatic sidebar management

# Script directory
%hidden YAZIBAR_SCRIPTS="$HOME/.core/cfg/tmux/modules/yazibar/scripts"

# ============================================================================
# LAYOUT HOOKS
# ============================================================================

# After splitting window, restore locked dimensions
set-hook -g after-split-window[0] "run-shell '$HOME/.core/cfg/tmux/scripts/layout-manager.sh restore'"

# After killing pane, restore locked dimensions
set-hook -g after-kill-pane[2] "run-shell '$HOME/.core/cfg/tmux/scripts/layout-manager.sh restore'"

# After window resize, restore locked dimensions
set-hook -g window-resized[0] "run-shell '$HOME/.core/cfg/tmux/scripts/layout-manager.sh restore'"

# ============================================================================
# SIDEBAR MAINTENANCE HOOKS
# ============================================================================

# DISABLED: These hooks were too aggressive and created duplicate sidebars
# Users should manually toggle sidebars with Alt+f / Alt+F instead
# set-hook -g after-split-window[10] "run-shell '$YAZIBAR_SCRIPTS/yazibar-left.sh ensure'"
# set-hook -g after-split-window[11] "run-shell '$YAZIBAR_SCRIPTS/yazibar-right.sh ensure'"
# set-hook -g after-kill-pane[10] "run-shell '$YAZIBAR_SCRIPTS/yazibar-left.sh ensure'"
# set-hook -g after-kill-pane[11] "run-shell '$YAZIBAR_SCRIPTS/yazibar-right.sh ensure'"

# Check right sidebar dependency on left sidebar (when left is killed, disable right)
set-hook -g after-kill-pane[12] "run-shell '$YAZIBAR_SCRIPTS/yazibar-right.sh check-dependency'"

# Enforce sidebar positions after split/kill/move operations
# DISABLED: Can cause issues with layout restoration
# set-hook -g after-split-window[20] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"
# set-hook -g after-kill-pane[20] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"
# set-hook -g pane-focus-in[10] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"

# ============================================================================
# WIDTH PERSISTENCE HOOKS
# ============================================================================

# DISABLED: Auto-save runs on every layout change and can cause input lag
# Users should manually save widths if needed, or resize will be remembered next time
# set-hook -g window-layout-changed "run-shell '$YAZIBAR_SCRIPTS/yazibar-width.sh auto-save'"

# ============================================================================
# NVIM INTEGRATION HOOKS
# ============================================================================

# DISABLED: Auto-register runs pstree/find on every focus and causes input locking
# Users should manually register nvim with Alt+n keybinding instead
# set-hook -g pane-focus-in "run-shell '$YAZIBAR_SCRIPTS/yazibar-nvim.sh auto-register'"

# ============================================================================
# CLEANUP HOOKS
# ============================================================================

# Cleanup locked panes when pane exits
set-hook -g pane-exited[0] "run-shell '$HOME/.core/cfg/tmux/scripts/layout-manager.sh cleanup'"

# Cleanup yazibar state when sidebar panes exit (window-scoped)
set-hook -g pane-exited[5] "run-shell '\
    window_id=\"#{window_id}\"; \
    left_pane=\$(tmux show-option -gqv \"@yazibar-left-pane-id-\${window_id}\"); \
    right_pane=\$(tmux show-option -gqv \"@yazibar-right-pane-id-\${window_id}\"); \
    exited_pane=\"#{pane_id}\"; \
    if [ \"\$exited_pane\" = \"\$left_pane\" ]; then \
        tmux set-option -gu \"@yazibar-left-enabled-\${window_id}\"; \
        tmux set-option -gu \"@yazibar-left-pane-id-\${window_id}\"; \
    fi; \
    if [ \"\$exited_pane\" = \"\$right_pane\" ]; then \
        tmux set-option -gu \"@yazibar-right-enabled-\${window_id}\"; \
        tmux set-option -gu \"@yazibar-right-pane-id-\${window_id}\"; \
        tmux set-option -gu \"@yazibar-sync-active-\${window_id}\"; \
        watcher_pid=\$(tmux show-option -gqv \"@yazibar-sync-watcher-pid-\${window_id}\"); \
        [ -n \"\$watcher_pid\" ] && kill \"\$watcher_pid\" 2>/dev/null; \
        tmux set-option -gu \"@yazibar-sync-watcher-pid-\${window_id}\"; \
    fi'"
