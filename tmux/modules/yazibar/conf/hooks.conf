# Yazibar - Hooks Configuration
# Tmux hooks for automatic sidebar management
# FIXED VERSION: Aligned with main hooks.conf, proper hook indices

# Script directory
%hidden YAZIBAR_SCRIPTS="$TMUX_MODULES/yazibar/scripts"

# ============================================================================
# HOOK INDEX ALLOCATION (matches conf/hooks.conf)
# ============================================================================
# [0-4]   - Pre-layout operations (cleanup, renumbering)
# [5-9]   - Layout restoration (layout-manager)
# [10-14] - Yazibar state management
# [15-19] - Yazibar layout enforcement (DISABLED - causes conflicts)
# [20+]   - Post-layout operations (GPG, etc.)

# ============================================================================
# YAZIBAR STATE CLEANUP (Index 11-12)
# ============================================================================

# Check right sidebar dependency when left sidebar is killed
# Index 12 runs after layout-manager restore at index 5
set-hook -g after-kill-pane[12] "run-shell '\
    # Skip if layout restore is in progress
    if [ \"$(tmux show-option -gqv @layout-restore-in-progress)\" = \"1\" ]; then
        exit 0
    fi
    $YAZIBAR_SCRIPTS/yazibar-right.sh check-dependency 2>/dev/null || true
'"

# ============================================================================
# SIDEBAR MAINTENANCE HOOKS (ALL DISABLED)
# ============================================================================
# These hooks were too aggressive and caused:
#   - Duplicate sidebars
#   - Layout instability
#   - Race conditions with layout-manager
# Users should manually toggle sidebars with Alt+f / Alt+F instead

# DISABLED: after-split-window - would create loops during sidebar creation
# set-hook -g after-split-window[11] "run-shell '$YAZIBAR_SCRIPTS/yazibar-left.sh ensure'"

# DISABLED: after-kill-pane ensure - interferes with layout-manager
# set-hook -g after-kill-pane[11] "run-shell '$YAZIBAR_SCRIPTS/yazibar-left.sh ensure'"

# ============================================================================
# LAYOUT ENFORCEMENT HOOKS (ALL DISABLED)
# ============================================================================
# These hooks attempted to enforce sidebar positions but caused:
#   - Conflicts with layout-manager restoration
#   - Unexpected pane movements
#   - Performance issues

# DISABLED: Can cause conflicts with layout-manager restoration
# set-hook -g after-split-window[15] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"
# set-hook -g after-kill-pane[15] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"
# set-hook -g pane-focus-in[15] "run-shell '$YAZIBAR_SCRIPTS/yazibar-layout.sh enforce'"

# ============================================================================
# WIDTH PERSISTENCE HOOKS (DISABLED)
# ============================================================================
# Auto-save runs on every layout change and causes input lag
# Users should manually save widths if needed

# DISABLED: Causes input lag
# set-hook -g window-layout-changed "run-shell '$YAZIBAR_SCRIPTS/yazibar-width.sh auto-save'"

# ============================================================================
# NVIM INTEGRATION HOOKS (DISABLED)
# ============================================================================
# Auto-register runs pstree/find on every focus and causes input locking
# Users should manually register nvim with Alt+n keybinding

# DISABLED: Causes input locking
# set-hook -g pane-focus-in "run-shell '$YAZIBAR_SCRIPTS/yazibar-nvim.sh auto-register'"

# ============================================================================
# PANE EXIT CLEANUP (Index 11)
# ============================================================================
# Cleanup yazibar state when sidebar panes exit (window-scoped)
# This hook clears the stored pane IDs and stops sync watchers
# when sidebar panes are closed

set-hook -g pane-exited[11] "run-shell '\
    window_id=\"#{window_id}\"
    left_pane=\"$(tmux show-option -gqv \"@yazibar-left-pane-id-\${window_id}\")\"
    right_pane=\"$(tmux show-option -gqv \"@yazibar-right-pane-id-\${window_id}\")\"
    exited_pane=\"#{pane_id}\"

    # Handle left sidebar exit
    if [ -n \"\$left_pane\" ] && [ \"\$exited_pane\" = \"\$left_pane\" ]; then
        tmux set-option -gu \"@yazibar-left-enabled-\${window_id}\"
        tmux set-option -gu \"@yazibar-left-pane-id-\${window_id}\"
        # Unlock the pane from layout-manager
        $TMUX_CONF/scripts/layout-manager.sh unlock \"\$exited_pane\" 2>/dev/null || true
    fi

    # Handle right sidebar exit
    if [ -n \"\$right_pane\" ] && [ \"\$exited_pane\" = \"\$right_pane\" ]; then
        tmux set-option -gu \"@yazibar-right-enabled-\${window_id}\"
        tmux set-option -gu \"@yazibar-right-pane-id-\${window_id}\"
        tmux set-option -gu \"@yazibar-sync-active-\${window_id}\"
        # Stop sync watcher if running
        watcher_pid=\"$(tmux show-option -gqv \"@yazibar-sync-watcher-pid-\${window_id}\")\"
        if [ -n \"\$watcher_pid\" ]; then
            kill \"\$watcher_pid\" 2>/dev/null || true
        fi
        tmux set-option -gu \"@yazibar-sync-watcher-pid-\${window_id}\"
        # Unlock the pane from layout-manager
        $TMUX_CONF/scripts/layout-manager.sh unlock \"\$exited_pane\" 2>/dev/null || true
    fi
'"
