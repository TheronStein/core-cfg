# ============================================================================
# Core-IDE Unified Keybindings
# Harmonized keybindings across tmux, yazi, neovim, and wezterm
# ============================================================================

# ============================================================================
# NAVIGATION LAYER - Seamless navigation across all tools
# ============================================================================

# Smart pane navigation (works with vim-tmux-navigator in neovim)
bind -n M-h if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -n M-j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -n M-k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -n M-l if -F '#{pane_at_right}'  '' 'select-pane -R'

# Alternative arrow key navigation
bind -n M-Left  select-pane -L
bind -n M-Down  select-pane -D
bind -n M-Up    select-pane -U
bind -n M-Right select-pane -R

# Window navigation
bind -n M-1 select-window -t :1
bind -n M-2 select-window -t :2
bind -n M-3 select-window -t :3
bind -n M-4 select-window -t :4
bind -n M-5 select-window -t :5
bind -n M-6 select-window -t :6
bind -n M-7 select-window -t :7
bind -n M-8 select-window -t :8
bind -n M-9 select-window -t :9

# Cycle through windows
# # bind -n M-n next-window
# bind -n M-p previous-window
# bind -n C-Tab last-window

# ============================================================================
# YAZI SIDEBAR INTEGRATION
# ============================================================================

# Toggle yazi sidebars (using yazibar module)
bind -n C-M-e run-shell "$TMUX_MODULES/yazibar/scripts/yazibar-left.sh toggle"
bind -n C-M-E run-shell "$TMUX_MODULES/yazibar/scripts/yazibar-right.sh toggle"

# Focus yazi sidebar
# bind -n M-g if -F '#{@yazi-sidebar-pane-id}' \
#     'select-pane -t "#{@yazi-sidebar-pane-id}"' \
#     'run-shell "$TMUX_CONF/scripts/yazi-integration.sh create-left"'

# Sync yazi with neovim
# bind -n M-s run-shell "$TMUX_CONF/scripts/yazi-integration.sh sync-to-nvim"

# Open file from yazi in neovim
# bind -n M-o run-shell "$TMUX_CONF/scripts/yazi-integration.sh open-in-nvim"

# ============================================================================
# CORE-IDE WORKSPACE MANAGEMENT
# ============================================================================

# Socket context switcher
bind S display-popup -E -w 60% -h 50% "$HOME/.local/bin/core-ide-switch"
bind C run-shell "$HOME/.local/bin/core-ide-status"

# Layout management
# bind L display-menu -x C -y C -T "#[fg=#e0af68,bold] Layouts " \
#     "Default (Dual Sidebars)" d "source-file '$HOME/.local/state/core-ide/layouts/default.tmux'" \
#     "Code (Editor + Term)" c "source-file '$HOME/.local/state/core-ide/layouts/code.tmux'" \
#     "Review (Diff + Blame)" r "source-file '$HOME/.local/state/core-ide/layouts/review.tmux'" \
#     "Debug (Debug + Watch)" D "source-file '$HOME/.local/state/core-ide/layouts/debug.tmux'"

# Quick layout switching
# bind -n M-F1 source-file "core-ide/layouts/default.tmux"
# bind -n M-F2 source-file "core-ide/layouts/code.tmux"
# bind -n M-F3 source-file "core-ide/layouts/review.tmux"
# bind -n M-F4 source-file "core-ide/layouts/debug.tmux"

# bind -n M-F1 source-file "$HOME/.local/state/core-ide/layouts/default.tmux"
# bind -n M-F2 source-file "$HOME/.local/state/core-ide/layouts/code.tmux"
# bind -n M-F3 source-file "$HOME/.local/state/core-ide/layouts/review.tmux"
# bind -n M-F4 source-file "$HOME/.local/state/core-ide/layouts/debug.tmux"

# ============================================================================
# FZF INTEGRATION
# ============================================================================

# FZF file finder
bind -n M-f display-popup -E -w 80% -h 80% \
    "fd --type f --hidden --follow --exclude .git | \
     fzf --preview 'bat --style=numbers --color=always {}' \
         --bind 'enter:execute(tmux send-keys -t :.1 \"nvim {}\" Enter)+abort'"

# FZF git status
bind -n M-F display-popup -E -w 80% -h 80% \
    "git status -s | \
     fzf --preview 'git diff --color=always {2}' \
         --bind 'enter:execute(tmux send-keys -t :.1 \"nvim {2}\" Enter)+abort'"

# FZF session switcher
bind -n M-w display-popup -E -w 60% -h 40% \
    "tmux list-sessions -F '#{session_name}' | \
     fzf --preview 'tmux list-windows -t {} -F \"#I: #W\"' \
         --bind 'enter:execute(tmux switch-client -t {})+abort'"

# FZF command history
bind -n M-r display-popup -E -w 80% -h 60% \
    "history | fzf --tac --no-sort | cut -d' ' -f2- | tmux load-buffer - && tmux paste-buffer"

# ============================================================================
# NEOVIM INTEGRATION
# ============================================================================

# Open neovim in current pane
bind v send-keys "nvim" Enter

# Open neovim in new split
bind V split-window -h "nvim"

# Send selection to neovim
bind -n M-v if -F '#{selection_active}' \
    'send-keys -X copy-pipe "nvim -"' \
    'split-window -h "nvim"'

# Quick edit tmux config
bind E split-window -h "nvim $TMUX_CONF/tmux.conf"

# ============================================================================
# POPUP WINDOWS
# ============================================================================

# Floating terminal
bind t display-popup -E -w 80% -h 60% -d "#{pane_current_path}" "$SHELL"

# Lazygit popup
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# Task manager popup
bind T display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "taskwarrior-tui"

# System monitor popup
bind M display-popup -E -w 90% -h 90% "btop"

# ============================================================================
# CLIPBOARD INTEGRATION
# ============================================================================

# Copy mode with vi keys
bind [ copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "wl-copy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "wl-copy"

# Paste from system clipboard
bind ] run-shell "wl-paste | tmux load-buffer - && tmux paste-buffer"

# ============================================================================
# STATE PERSISTENCE
# ============================================================================

# Save current state
# TODO: yazi-integration.sh archived - need yazibar equivalent
# bind C-s run-shell "$TMUX_CONF/scripts/yazi-integration.sh save-state"

# Restore state
# TODO: yazi-integration.sh archived - need yazibar equivalent
# bind C-r run-shell "$TMUX_CONF/scripts/yazi-integration.sh restore-state"

# Quick save/restore with resurrect
bind S run-shell "$TMUX_CONF/plugins/tmux-resurrect/scripts/save.sh"
bind R run-shell "$TMUX_CONF/plugins/tmux-resurrect/scripts/restore.sh"

# ============================================================================
# RESIZE MODE
# ============================================================================

# Enter resize mode
bind r switch-client -T resize

# Resize panes in resize mode
bind -T resize h resize-pane -L 5
bind -T resize j resize-pane -D 5
bind -T resize k resize-pane -U 5
bind -T resize l resize-pane -R 5

bind -T resize H resize-pane -L 10
bind -T resize J resize-pane -D 10
bind -T resize K resize-pane -U 10
bind -T resize L resize-pane -R 10

# Fine-grained resize
bind -T resize C-h resize-pane -L 1
bind -T resize C-j resize-pane -D 1
bind -T resize C-k resize-pane -U 1
bind -T resize C-l resize-pane -R 1

# Exit resize mode
bind -T resize q switch-client -T root
bind -T resize Escape switch-client -T root

# ============================================================================
# EMERGENCY COMMANDS
# ============================================================================

# Kill current pane (with confirmation)
bind x confirm-before -p "Kill pane #P? (y/n)" kill-pane

# Kill current window (with confirmation)
bind X confirm-before -p "Kill window #W? (y/n)" kill-window

# Respawn pane
bind R respawn-pane -k

# Clear scrollback
bind C-l clear-history

# ============================================================================
# HELP & DOCUMENTATION
# ============================================================================

# Show keybinding help
bind ? display-popup -E -w 80% -h 80% \
    "echo 'Core-IDE Keybindings' && echo '' && \
     tmux list-keys | grep -E 'bind|Core-IDE' | \
     fzf --header='Search keybindings (ESC to exit)'"

# Show Core-IDE help
bind H display-popup -E -w 70% -h 70% \
    "cat $HOME/.local/state/core-ide/README.md 2>/dev/null || \
     echo 'Core-IDE Help not found. Run core-ide-setup.sh first.'"

# vim: ft=tmux
