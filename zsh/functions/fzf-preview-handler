#!/usr/bin/env zsh
# fzf-preview-handler - Universal preview handler for fzf
# Provides intelligent previews for files, directories, commands, man pages, etc.
#
# Usage: fzf-preview-handler <target>
#
# Detects target type and shows appropriate preview:
#   - Directories: tree/eza listing
#   - Text files: bat/cat with syntax highlighting
#   - Binaries: file info + --help output
#   - Commands: man page or --help
#   - Archives: contents listing
#   - Images: file info (or chafa if available)
#   - Git objects: git show/log

fzf-preview-handler() {
    local target="$1"

    # Handle empty input
    if [[ -z "$target" ]]; then
        echo -e "\033[2m(no selection)\033[0m"
        return 0
    fi

    # Strip ANSI codes if present
    target=$(echo "$target" | sed 's/\x1b\[[0-9;]*m//g')

    # === DIRECTORY ===
    if [[ -d "$target" ]]; then
        echo -e "\033[1;34mðŸ“ Directory:\033[0m $target"
        echo ""
        eza --color=always --icons --group-directories-first -la "$target" 2>/dev/null || \
        ls -la --color=always "$target" 2>/dev/null || \
        ls -la "$target"
        return 0
    fi

    # === SYMLINK ===
    if [[ -L "$target" ]]; then
        local link_target=$(readlink -f "$target" 2>/dev/null || readlink "$target")
        echo -e "\033[1;36mðŸ”— Symlink:\033[0m $target"
        echo -e "\033[1;36mâ†’\033[0m $link_target"
        echo ""
        if [[ -e "$link_target" ]]; then
            fzf-preview-handler "$link_target"
        fi
        return 0
    fi

    # === REGULAR FILE ===
    if [[ -f "$target" ]]; then
        local mime=$(file --mime-type -b "$target" 2>/dev/null)
        local file_info=$(file -b "$target" 2>/dev/null)

        # Check file size
        local size=$(stat -c%s "$target" 2>/dev/null || stat -f%z "$target" 2>/dev/null || echo 0)

        # === BINARY/EXECUTABLE ===
        if [[ "$file_info" =~ "executable" || "$file_info" =~ "shared object" || "$file_info" =~ "ELF" ]]; then
            echo -e "\033[1;35mâš¡ Executable:\033[0m $target"
            echo -e "\033[2m$file_info\033[0m"
            echo ""
            echo -e "\033[1;33mâ”€â”€â”€ Help Output â”€â”€â”€\033[0m"
            # Try various help flags
            "$target" --help 2>&1 | head -40 || \
            "$target" -h 2>&1 | head -40 || \
            "$target" help 2>&1 | head -40 || \
            echo "(no help available)"
            return 0
        fi

        # === ARCHIVE FILES ===
        case "${target:l}" in
            *.tar|*.tar.gz|*.tgz|*.tar.bz2|*.tbz2|*.tar.xz|*.txz|*.tar.zst)
                echo -e "\033[1;33mðŸ“¦ Archive:\033[0m $target"
                tar -tvf "$target" 2>/dev/null | head -50
                return 0
                ;;
            *.zip)
                echo -e "\033[1;33mðŸ“¦ ZIP Archive:\033[0m $target"
                unzip -l "$target" 2>/dev/null | head -50
                return 0
                ;;
            *.7z)
                echo -e "\033[1;33mðŸ“¦ 7z Archive:\033[0m $target"
                7z l "$target" 2>/dev/null | head -50
                return 0
                ;;
            *.rar)
                echo -e "\033[1;33mðŸ“¦ RAR Archive:\033[0m $target"
                unrar l "$target" 2>/dev/null | head -50
                return 0
                ;;
        esac

        # === IMAGE FILES ===
        case "$mime" in
            image/*)
                echo -e "\033[1;32mðŸ–¼ï¸  Image:\033[0m $target"
                echo -e "\033[2m$file_info\033[0m"
                # Try chafa for terminal image preview
                if command -v chafa &>/dev/null; then
                    chafa --size=60x30 "$target" 2>/dev/null
                fi
                return 0
                ;;
        esac

        # === PDF FILES ===
        if [[ "$mime" == "application/pdf" ]]; then
            echo -e "\033[1;31mðŸ“„ PDF:\033[0m $target"
            pdftotext -l 2 -layout "$target" - 2>/dev/null | head -60 || \
            echo "(install poppler for PDF preview)"
            return 0
        fi

        # === LARGE FILES ===
        if [[ "$size" -gt 2097152 ]]; then
            echo -e "\033[1;33mâš  Large file:\033[0m $target"
            echo -e "\033[2mSize: $(numfmt --to=iec $size 2>/dev/null || echo "$size bytes")\033[0m"
            echo -e "\033[2m$file_info\033[0m"
            echo ""
            echo -e "\033[2m(showing first 100 lines)\033[0m"
            head -100 "$target" 2>/dev/null
            return 0
        fi

        # === TEXT/CODE FILES (default) ===
        bat --color=always --style=numbers,changes,header --line-range :200 "$target" 2>/dev/null || \
        batcat --color=always --style=numbers --line-range :200 "$target" 2>/dev/null || \
        head -200 "$target" 2>/dev/null || \
        echo -e "\033[1;32mðŸ“„ File:\033[0m $target"
        return 0
    fi

    # === COMMAND/BINARY NAME (not a path) ===
    if command -v "$target" &>/dev/null; then
        local cmd_path=$(command -v "$target")
        echo -e "\033[1;35mâš¡ Command:\033[0m $target"
        echo -e "\033[2mPath: $cmd_path\033[0m"
        echo ""

        # Try man page first
        if man -w "$target" &>/dev/null; then
            echo -e "\033[1;33mâ”€â”€â”€ Manual Page â”€â”€â”€\033[0m"
            man "$target" 2>/dev/null | col -bx | head -60
        else
            # Fall back to --help
            echo -e "\033[1;33mâ”€â”€â”€ Help Output â”€â”€â”€\033[0m"
            "$target" --help 2>&1 | head -50 || \
            "$target" -h 2>&1 | head -50 || \
            echo "(no documentation available)"
        fi
        return 0
    fi

    # === GIT OBJECTS (commit hashes, branches) ===
    if git rev-parse "$target" &>/dev/null 2>&1; then
        echo -e "\033[1;33mðŸ”– Git Object:\033[0m $target"
        git show --color=always "$target" 2>/dev/null | head -60 || \
        git log --oneline --graph --color=always "$target" 2>/dev/null | head -30
        return 0
    fi

    # === FALLBACK ===
    echo -e "\033[1;33mðŸ“‹ Item:\033[0m $target"
    echo ""

    # Try to get any info about it
    type "$target" 2>/dev/null || \
    whence -v "$target" 2>/dev/null || \
    echo "(unknown type)"
}

# Run if called directly
if [[ "${(%):-%N}" == "$0" ]]; then
    fzf-preview-handler "$@"
fi
