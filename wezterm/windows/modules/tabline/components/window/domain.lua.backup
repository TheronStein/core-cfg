local wezterm = require("wezterm")
local util = require("tabline.util")

return {
	default_opts = {
		domain_to_icon = {
			default = wezterm.nerdfonts.md_monitor,
			ssh = wezterm.nerdfonts.md_ssh,
			sshmux = wezterm.nerdfonts.md_ssh,
			wsl = wezterm.nerdfonts.md_microsoft_windows,
			docker = wezterm.nerdfonts.md_docker,
			unix = wezterm.nerdfonts.cod_terminal_linux,
		},
	},
	update = function(window, opts)
		local pane = window:active_pane()
		if not pane then
			return nil
		end

		-- Wrap in pcall to handle race conditions when panes are closed
		local success, domain_name = pcall(function()
			return pane:get_domain_name()
		end)

		if not success or not domain_name then
			return nil
		end

		local domain_type, new_domain_name = domain_name:match("^([^:]+):%s*(.*)")
		domain_type = (domain_type or "default"):lower()
		new_domain_name = new_domain_name ~= "" and new_domain_name or domain_name

		if opts.icons_enabled and opts.domain_to_icon then
			local icon = opts.domain_to_icon[domain_type] or opts.domain_to_icon.default
			util.overwrite_icon(opts, icon)
		end

		if new_domain_name == "local" then
			new_domain_name = wezterm.hostname()
			local icon = wezterm.nerdfonts.linux_archlinux
			util.overwrite_icon(opts, icon)
		elseif wezterm.hostname() == "chaoscore" then
			local icon = "î € " -- Custom icon for chaoscore
			util.overwrite_icon(opts, icon)
		end

		return new_domain_name
	end,
}
